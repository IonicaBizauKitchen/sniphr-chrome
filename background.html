<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
		<script src="config.js" type="text/javascript"></script>
		<script src="common.js" type="text/javascript"></script>
		<script src="jquery-1.5.1.min.js" type="text/javascript"></script>
    <script>

      // Saves a sniph
      function saveSniph(data, callback) {
				log('saveSniph');
				
				if (Sniphr.disabled()) {
					log('disabled (therefore not saving)')
					return false;
				}

				// Content scripts don't have access to localStorage, 
				// so we're fetching the username from here instead..
				data.sniph.user = localStorage['username'];
				data.sniph.publique = localStorage['mode'] == 'public';
				var url = config.host + "sniphs/save.json?" + $.param(data);
				AjaxRequest(url, callback);
      };

      function findSniphsForURL(url, callback) {
				log('findSniphsForURL ' + url);

				// e.g. 'q=http://example.com/foo&from_user=bob'
				var query = {
					q: url,
					from_user: localStorage['username']
				};
				var url = config.host + "sniphs.json?" + $.param(query);
				
				AjaxRequest(url, callback);
      };

			// Handles data sent via chrome.extension.sendRequest().
      function onRequest(request, sender, callback) {
				switch (request.action) {
					case 'saveSniph':
						saveSniph(request.data, callback);
						break;
					case 'findSniphsForURL':
						findSniphsForURL(request.url, callback);
						break;
				}
      };
      chrome.extension.onRequest.addListener(onRequest);

			// Handle localStorage defaults
			if (!localStorage['mode']) localStorage["mode"] = config.localStorage.defaults.mode;

			log('background.html loaded');
    </script>
  </body>
</html>