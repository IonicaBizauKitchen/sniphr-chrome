<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
		<script src="config.js" type="text/javascript"></script>
		<script src="common.js" type="text/javascript"></script>
		<script src="jquery-1.5.1.min.js" type="text/javascript"></script>
    <script>

      // Saves a sniph
      function saveSniph(data, callback) {
				log('saveSniph');
				var url = config.host + "sniphs/save.json?" + $.param(data);

				// Not sure why, but the apostrophes don't get URL-encoded by $.param
				url = url.replace(/'/g, '%27');
				
				AjaxRequest(url, callback);
      };
      
      // Show a notification when sniphs are saved
      function notifySniphSaved(sniph) {
        var notification = webkitNotifications.createNotification('icon_48.png', 'Sniph!', $("<div>" + sniph.content + "</div>").text());
        notification.show();
        setTimeout(function(){notification.cancel();}, config.sniph.notification_timeout);
      }
      
      function getSessionStatus() {
        log('getSessionStatus')
				var url = config.host + "session_status.json";
				AjaxRequest(url, updateIcon);
      }
      
      // If session status Ajax response contains a user,
      // use user.mode to set icon path. Otherwise show disabled icon.
      function updateIcon(data) {
        if (data.user) {
          path = "icon_" + data.user.mode + ".png";
        } else {
          path = "icon_disabled.png";
        }
        chrome.browserAction.setIcon({path: path});
        log('updateIcon: ' + path);
      }

      // Store the URL so the options page can pass it to its sniphr.com iFRAME      
      function logCurrentURL(url) {
				log('logCurrentURL ' + url);
        localStorage['last_url'] = url
      };      

      function findSniphsForURL(url, callback) {
				log('findSniphsForURL ' + url);
			
				// e.g. 'q=http://example.com/foo
				var query = {
					q: url
				};
				var url = config.host + "sniphs.json?" + $.param(query);
				
				AjaxRequest(url, callback);
      };

			// Handles data sent via chrome.extension.sendRequest().
      function onRequest(request, sender, callback) {
				switch (request.action) {
					case 'saveSniph':
						saveSniph(request.data, callback);
						break;
					case 'logCurrentURL':
						logCurrentURL(request.url);
						break;
					case 'findSniphsForURL':
						findSniphsForURL(request.url, callback);
						break;
					case 'notifySniphSaved':
						notifySniphSaved(request.sniph);
						break;
					case 'getSessionStatus':
						getSessionStatus();
						break;
						
				}
      };
      chrome.extension.onRequest.addListener(onRequest);

			log('background.html loaded');
    </script>
  </body>
</html>