<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
		<script src="config.js" type="text/javascript"></script>
		<script src="common.js" type="text/javascript"></script>
		<script src="jquery-1.5.1.min.js" type="text/javascript"></script>
    <script>

      // Saves a sniph
      function saveSniph(data, callback) {
				log('saveSniph');				
				var url = config.host + "sniphs/save.json?" + $.param(data);
				AjaxRequest(url, callback);
      };
      
      function notifySniphSaved(sniph) {
        var notification = webkitNotifications.createNotification('icon_48.png', 'Sniph!', $("<div>" + sniph.content + "</div>").text());
        notification.show();
        setTimeout(function(){notification.cancel();}, config.sniph.notification_timeout);
      }

      function findSniphsForURL(url, callback) {
				log('findSniphsForURL ' + url);
				
				// Store the URL so the options page can pass it to its sniphr.com iFRAME
        localStorage['last_url'] = url

				// e.g. 'q=http://example.com/foo
				var query = {
					q: url
				};
				var url = config.host + "sniphs.json?" + $.param(query);
				
				AjaxRequest(url, callback);
      };

			// Handles data sent via chrome.extension.sendRequest().
      function onRequest(request, sender, callback) {
				switch (request.action) {
					case 'saveSniph':
						saveSniph(request.data, callback);
						break;
					case 'findSniphsForURL':
						findSniphsForURL(request.url, callback);
						break;
					case 'notifySniphSaved':
						notifySniphSaved(request.sniph);
						break;
						
				}
      };
      chrome.extension.onRequest.addListener(onRequest);

			log('background.html loaded');
    </script>
  </body>
</html>